# Development Design

- [x] Record the tree structure of the data
- [x] Output the structured json data using directory?
    - In this way, for every json, we can find its parent and grandparents till root. Thus, we might know more detail information regarding the code.
    - Use a TREE_JSON to alternate between tree and list modes
- [x] Use a public LLM to comment
    - [x] 考虑汇总信息、以及每个文件夹的分析(`xxx.py.analyze.md`)是否使用JSON格式(`xxx.py.analyze.json`)
        - ChatGLM4的json模式输出没有包含所有内容，放弃
    - [x] Use ZhipuAI LLM API
        - 对于2000行的超长类，GLM4已经忘了自己的注释的目标，没有写任何注释。这样来看，一个类并不适合直接放在一个对话框中分析。而且这种超长context也非常烧钱（特别是GLM是把input token跟output token一起算的）
    - [x] Comment the whole file
        - [x] Solve the incomplete big file problem in ZhipuAI's API: 
            - The file is only 100 line. It's not too big at all. Some functions and most classes have more code than that. 这个问题在comment json文件的时候也遇到了，所以必须解决。
            - [x] 其实这个是截断问题。如果再输入“继续”则可以继续输出(需要引入历史)
                - 考虑：判断是否已输出所有行（粗略可以用行数来判断）。如果还没有输出完，则接着前面的历史，自己输出“继续”。
                - 考虑：使用langchain拆分，可以试试sliding window等方式
    - [x] Comment one section by one section using AST analyzed structure
        - [ ] 有时候会逐行分析，可能需要在提示词中One-shot
        - [ ] 应该能够切换颗粒度，一种是只在方法/函数上面注释，一种是逐行注释。默认是第一种。第二种需要注意输出可能不够大，需要手动继续。【直接用CodeGeex的 Auto Comment 即可，不必使用我这里的方法】
        - [ ] 需要在类上面加上注释
- [x] Write prompt to comment
- [x] Write comments in a json
- [ ] 加上对于 Java, JavaScript, TypeScript, Go, C, C++ 等语言的解析
    - [ ] 考虑使用tree-sitter： https://github.com/tree-sitter/tree-sitter
- [ ] Epic: 调研增量代码问题
    - [ ] 增量代码考虑 tree-sitter 的能力
    - [ ] 增量代码的元数据和 git commit 的关系对应
    - [ ] 增量代码的元数据在尽量少的元数据情况下更新
- [ ] 更新 base LLM
    - [ ] 找一个不计算输入token，只计算输出token的LLM
        - [ ] Adjust prompt accordingly.
    - [ ] Use a private LLM through ollama to comment
        - [ ] Adjust prompt accordingly.
- [ ] Write comments back into the file? (暂时先不考虑，因为这个是侵入性的，而且不可以复用)
    - [ ] Write-back should occur backward

